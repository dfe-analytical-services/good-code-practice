<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Chapter 6 Advanced: Testing code | Good code practice</title>
  <meta name="description" content="This is a minimal example of using the bookdown package to write a book. The output format for this example is bookdown::gitbook." />
  <meta name="generator" content="bookdown 0.17 and GitBook 2.6.7" />

  <meta property="og:title" content="Chapter 6 Advanced: Testing code | Good code practice" />
  <meta property="og:type" content="book" />
  
  
  <meta property="og:description" content="This is a minimal example of using the bookdown package to write a book. The output format for this example is bookdown::gitbook." />
  <meta name="github-repo" content="rstudio/bookdown-demo" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 6 Advanced: Testing code | Good code practice" />
  
  <meta name="twitter:description" content="This is a minimal example of using the bookdown package to write a book. The output format for this example is bookdown::gitbook." />
  

<meta name="author" content="Department for Education guidance" />


<meta name="date" content="2020-04-09" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="code-structure.html"/>
<link rel="next" href="VC.html"/>
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />











<style type="text/css">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; left: -4em; }
pre.numberSource a.sourceLine::before
  { content: attr(title);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li class="chapter" data-level="1" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i><b>1</b> The QA framework</a><ul>
<li class="chapter" data-level="1.1" data-path="index.html"><a href="index.html#writing-code-for-qa"><i class="fa fa-check"></i><b>1.1</b> Writing code for QA</a></li>
<li class="chapter" data-level="1.2" data-path="index.html"><a href="index.html#our-approach-to-writing-and-updating-this-guidance"><i class="fa fa-check"></i><b>1.2</b> Our approach to writing and updating this guidance</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="the-fundamentals-of-writing-good-code.html"><a href="the-fundamentals-of-writing-good-code.html"><i class="fa fa-check"></i><b>2</b> The fundamentals of writing good code</a><ul>
<li class="chapter" data-level="2.1" data-path="the-fundamentals-of-writing-good-code.html"><a href="the-fundamentals-of-writing-good-code.html#why-writing-good-code-is-so-important"><i class="fa fa-check"></i><b>2.1</b> Why writing good code is so important</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="fundamentals-how-to-write-good-code.html"><a href="fundamentals-how-to-write-good-code.html"><i class="fa fa-check"></i><b>3</b> Fundamentals: How to write good code</a></li>
<li class="chapter" data-level="4" data-path="fundamentals-what-good-code-looks-like.html"><a href="fundamentals-what-good-code-looks-like.html"><i class="fa fa-check"></i><b>4</b> Fundamentals: What good code looks like</a><ul>
<li class="chapter" data-level="4.1" data-path="fundamentals-what-good-code-looks-like.html"><a href="fundamentals-what-good-code-looks-like.html#a-clear-and-informative-header"><i class="fa fa-check"></i><b>4.1</b> A clear and informative Header</a></li>
<li class="chapter" data-level="4.2" data-path="fundamentals-what-good-code-looks-like.html"><a href="fundamentals-what-good-code-looks-like.html#consistent-use-of-indentation"><i class="fa fa-check"></i><b>4.2</b> Consistent use of indentation</a></li>
<li class="chapter" data-level="4.3" data-path="fundamentals-what-good-code-looks-like.html"><a href="fundamentals-what-good-code-looks-like.html#descriptive-use-of-variable-names"><i class="fa fa-check"></i><b>4.3</b> Descriptive use of variable names</a></li>
<li class="chapter" data-level="4.4" data-path="fundamentals-what-good-code-looks-like.html"><a href="fundamentals-what-good-code-looks-like.html#descriptive-and-informative-comments"><i class="fa fa-check"></i><b>4.4</b> Descriptive and informative comments</a></li>
<li class="chapter" data-level="4.5" data-path="fundamentals-what-good-code-looks-like.html"><a href="fundamentals-what-good-code-looks-like.html#a-clear-flow-and-structure"><i class="fa fa-check"></i><b>4.5</b> A clear flow and structure</a></li>
<li class="chapter" data-level="4.6" data-path="fundamentals-what-good-code-looks-like.html"><a href="fundamentals-what-good-code-looks-like.html#consistent-spacing"><i class="fa fa-check"></i><b>4.6</b> Consistent spacing</a></li>
<li class="chapter" data-level="4.7" data-path="fundamentals-what-good-code-looks-like.html"><a href="fundamentals-what-good-code-looks-like.html#if-required-the-use-of-functions-or-subroutines"><i class="fa fa-check"></i><b>4.7</b> If required, the use of functions or subroutines</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="code-structure.html"><a href="code-structure.html"><i class="fa fa-check"></i><b>5</b> Advanced: Optimising code structure</a></li>
<li class="chapter" data-level="6" data-path="testing.html"><a href="testing.html"><i class="fa fa-check"></i><b>6</b> Advanced: Testing code</a></li>
<li class="chapter" data-level="7" data-path="VC.html"><a href="VC.html"><i class="fa fa-check"></i><b>7</b> Advanced: Version control</a></li>
<li class="chapter" data-level="8" data-path="documenation.html"><a href="documenation.html"><i class="fa fa-check"></i><b>8</b> Advanced: Documentation</a><ul>
<li class="chapter" data-level="8.1" data-path="documenation.html"><a href="documenation.html#comments"><i class="fa fa-check"></i><b>8.1</b> Comments</a></li>
<li class="chapter" data-level="8.2" data-path="documenation.html"><a href="documenation.html#rmarkdown-file"><i class="fa fa-check"></i><b>8.2</b> Rmarkdown file</a></li>
<li class="chapter" data-level="8.3" data-path="documenation.html"><a href="documenation.html#packaging-your-analysis"><i class="fa fa-check"></i><b>8.3</b> Packaging your analysis</a></li>
<li class="chapter" data-level="8.4" data-path="documenation.html"><a href="documenation.html#a-word-on-package-version-and-dependency"><i class="fa fa-check"></i><b>8.4</b> A word on package version and dependency</a></li>
</ul></li>
<li class="chapter" data-level="9" data-path="Annex-A.html"><a href="Annex-A.html"><i class="fa fa-check"></i><b>9</b> Annex A: Version Control</a></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Good code practice</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="testing" class="section level1">
<h1><span class="header-section-number">Chapter 6</span> Advanced: Testing code</h1>
<p>From a coding point of view, testing covers the requirements spelled out in the <strong>Verification</strong> pillar of the QA framework. Note that testing does not overlap with the <strong>Validation</strong> QA pillar: it is concerned with code running properly rather than with the adequacy of model assumptions. Testing is a vast topic and it is beyond the scope of this guide to explore it in depth. Here we concentrate on broad principles corresponding to incrementally thorough testing. These ways of testing include:</p>
<ul>
<li>console tests</li>
<li>in-script testing</li>
<li>formal tests using tools such as <code>testthat</code> in R</li>
</ul>
<p>Testing code within the R console is not recommended as it leaves no trace or records of what has been checked. In-script testing is sufficient to facilitate QA in most cases, although tests should always be accompanied by brief comments signalling their presence and indicating what they are evaluating and what the expected output should be. For a quality assurer, running these tests ensures that the entire analytical workflow is reproducible. In R there are many ways to perfom in-script checks, from <code>print()</code> statements, to <code>base</code> functions <code>stop()</code> and <code>stopfinot()</code>, to functions from dedicated packages such as <code>assertthat</code> or <code>testit</code>. Examples are shown below.</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r badCode"><code class="sourceCode r"><a class="sourceLine" id="cb9-1" title="1"><span class="co"># This code snippet creates a function that</span></a>
<a class="sourceLine" id="cb9-2" title="2"><span class="co"># returns the maximum value of a vector</span></a>
<a class="sourceLine" id="cb9-3" title="3"><span class="co"># of numbers. The function contains </span></a>
<a class="sourceLine" id="cb9-4" title="4"><span class="co"># an in-script test checking that</span></a>
<a class="sourceLine" id="cb9-5" title="5"><span class="co"># its input is numerical. If the condition</span></a>
<a class="sourceLine" id="cb9-6" title="6"><span class="co"># is not met, execution is halted</span></a>
<a class="sourceLine" id="cb9-7" title="7">get_max &lt;-<span class="st"> </span><span class="cf">function</span>(x) {</a>
<a class="sourceLine" id="cb9-8" title="8">  <span class="kw">stopifnot</span>(<span class="kw">is.numeric</span>(x))</a>
<a class="sourceLine" id="cb9-9" title="9">  <span class="kw">max</span>(x)</a>
<a class="sourceLine" id="cb9-10" title="10">}</a>
<a class="sourceLine" id="cb9-11" title="11"></a>
<a class="sourceLine" id="cb9-12" title="12"><span class="kw">get_max</span>(<span class="kw">c</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">10</span>))</a>
<a class="sourceLine" id="cb9-13" title="13"><span class="co"># returns 10</span></a>
<a class="sourceLine" id="cb9-14" title="14"><span class="kw">get_max</span>(<span class="kw">c</span>(<span class="st">&quot;a&quot;</span>, <span class="st">&quot;b&quot;</span>, <span class="st">&quot;c&quot;</span>))</a>
<a class="sourceLine" id="cb9-15" title="15"><span class="co"># returns error message</span></a>
<a class="sourceLine" id="cb9-16" title="16"><span class="co"># Error in get_max(c(&quot;a&quot;, &quot;b&quot;, &quot;c&quot;)) : is.numeric(x) is not TRUE</span></a></code></pre></div>
<p>Beyond in-script tests, an analyst may decide to take a more formal approach to testing if the project warrants it. These require both writing tests in separate files and using specialised packages that run all tests at once and return success/failure feedback. The <code>testthat</code> package is a popular tool to write and run tests in R (Dev version is here <a href="https://github.com/r-lib/testthat" class="uri">https://github.com/r-lib/testthat</a> but also on CRAN). Altough most of its documentation and functionalities focus on testing in the context of package writing, <code>testthat</code> can also be used with regular R projects.</p>
<p>In <code>testthat</code>, tests are called <strong>expectations</strong>. These spell out the expected behaviour of a specific piece of code - typically a function. <code>testthat</code> provides many functionalities to define expectactions - see details at <a href="http://r-pkgs.had.co.nz/tests.html" class="uri">http://r-pkgs.had.co.nz/tests.html</a>. Expectations falling within a same testing <strong>context</strong> are stored in a same file and all testing files are saved within a dedicated testing directory. Below is an example of a file containing tests checking data integrity.</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb10-1" title="1"><span class="co"># This file is stored in a directory called &quot;testing_directory&quot; </span></a>
<a class="sourceLine" id="cb10-2" title="2"></a>
<a class="sourceLine" id="cb10-3" title="3"><span class="co"># Define context</span></a>
<a class="sourceLine" id="cb10-4" title="4"><span class="kw">context</span>(<span class="st">&quot;checking data integrity&quot;</span>)</a>
<a class="sourceLine" id="cb10-5" title="5"></a>
<a class="sourceLine" id="cb10-6" title="6"><span class="co"># The first test checks that the data set</span></a>
<a class="sourceLine" id="cb10-7" title="7"><span class="co"># &quot;mydata&quot; has a a single column and 100 rows</span></a>
<a class="sourceLine" id="cb10-8" title="8"><span class="kw">test_that</span>(<span class="st">&#39;data dimensions correct&#39;</span>, {</a>
<a class="sourceLine" id="cb10-9" title="9">  <span class="kw">expect_equal</span>(<span class="kw">ncol</span>(mydata), <span class="dv">1</span>)</a>
<a class="sourceLine" id="cb10-10" title="10">  <span class="kw">expect_equal</span>(<span class="kw">nrow</span>(mydata), <span class="dv">100</span>)</a>
<a class="sourceLine" id="cb10-11" title="11">})</a>
<a class="sourceLine" id="cb10-12" title="12"></a>
<a class="sourceLine" id="cb10-13" title="13"><span class="co"># The second test checks that the maximum value</span></a>
<a class="sourceLine" id="cb10-14" title="14"><span class="co"># of the variable &quot;some_numbers&quot; does not exceed 1</span></a>
<a class="sourceLine" id="cb10-15" title="15"><span class="kw">test_that</span>(<span class="st">&#39;no value greater than 1&#39;</span>, {</a>
<a class="sourceLine" id="cb10-16" title="16">  <span class="kw">expect_lt</span>(<span class="kw">max</span>(mydata<span class="op">$</span>some_numbers), <span class="dv">1</span>)</a>
<a class="sourceLine" id="cb10-17" title="17">})</a></code></pre></div>
<p>Expectations are tested using the <code>test_dir()</code> function, which takes the path to the testing directory as an argument.</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r badCode"><code class="sourceCode r"><a class="sourceLine" id="cb11-1" title="1"><span class="kw">library</span>(testthat)</a>
<a class="sourceLine" id="cb11-2" title="2"><span class="kw">library</span>(tidyverse)</a>
<a class="sourceLine" id="cb11-3" title="3"></a>
<a class="sourceLine" id="cb11-4" title="4"><span class="co"># create a data frame</span></a>
<a class="sourceLine" id="cb11-5" title="5">mydata &lt;-<span class="st"> </span><span class="kw">tibble</span>(<span class="dt">some_numbers =</span> <span class="kw">runif</span>(<span class="dv">100</span>))</a>
<a class="sourceLine" id="cb11-6" title="6"></a>
<a class="sourceLine" id="cb11-7" title="7"><span class="co"># test expectations and examine outputs</span></a>
<a class="sourceLine" id="cb11-8" title="8"><span class="co"># In this case, all tests are OK</span></a>
<a class="sourceLine" id="cb11-9" title="9"><span class="kw">test_dir</span>(<span class="st">&quot;testing_directory&quot;</span>)</a></code></pre></div>
<p><code>test_dir()</code> provides detailed outputs, including a time line of success/failure and any warnings that may have occured.</p>

</div>
            </section>

          </div>
        </div>
      </div>
<a href="code-structure.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="VC.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": null,
"toc": {
"collapse": "subsection"
}
});
});
</script>

</body>

</html>

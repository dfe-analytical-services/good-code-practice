<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Chapter 6 Advanced: Testing code | DfE Good Code Practice</title>
  <meta name="description" content="DfE Good Code Practide guide." />
  <meta name="generator" content="bookdown 0.21 and GitBook 2.6.7" />

  <meta property="og:title" content="Chapter 6 Advanced: Testing code | DfE Good Code Practice" />
  <meta property="og:type" content="book" />
  
  
  <meta property="og:description" content="DfE Good Code Practide guide." />
  <meta name="github-repo" content="rstudio/bookdown-demo" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 6 Advanced: Testing code | DfE Good Code Practice" />
  
  <meta name="twitter:description" content="DfE Good Code Practide guide." />
  

<meta name="author" content="Department for Education guidance" />


<meta name="date" content="2021-08-23" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  <link rel="shortcut icon" href="pictures/qa_logo.png" type="image/x-icon" />
<link rel="prev" href="code-structure.html"/>
<link rel="next" href="VC.html"/>
<script src="libs/header-attrs-2.7/header-attrs.js"></script>
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />











<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li class="toc-logo"><a href="./"><img src="pictures/qa_logo.png"></a></li>

<li class="divider"></li>
<li class="chapter" data-level="1" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i><b>1</b> Introduction</a>
<ul>
<li class="chapter" data-level="1.1" data-path="index.html"><a href="index.html#who-is-this-guide-for"><i class="fa fa-check"></i><b>1.1</b> Who is this guide for?</a></li>
<li class="chapter" data-level="1.2" data-path="index.html"><a href="index.html#writing-code-for-qa"><i class="fa fa-check"></i><b>1.2</b> Writing code for QA</a></li>
<li class="chapter" data-level="1.3" data-path="index.html"><a href="index.html#our-approach-to-writing-and-updating-this-guidance"><i class="fa fa-check"></i><b>1.3</b> Our approach to writing and updating this guidance</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="the-fundamentals-of-writing-good-code.html"><a href="the-fundamentals-of-writing-good-code.html"><i class="fa fa-check"></i><b>2</b> The fundamentals of writing good code</a>
<ul>
<li class="chapter" data-level="2.1" data-path="the-fundamentals-of-writing-good-code.html"><a href="the-fundamentals-of-writing-good-code.html#why-writing-good-code-is-so-important"><i class="fa fa-check"></i><b>2.1</b> Why writing good code is so important</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="fundamentals.html"><a href="fundamentals.html"><i class="fa fa-check"></i><b>3</b> Fundamentals: How to write good code</a></li>
<li class="chapter" data-level="4" data-path="good.html"><a href="good.html"><i class="fa fa-check"></i><b>4</b> Fundamentals: What good code looks like</a>
<ul>
<li class="chapter" data-level="4.1" data-path="good.html"><a href="good.html#a-clear-and-informative-header"><i class="fa fa-check"></i><b>4.1</b> A clear and informative Header</a></li>
<li class="chapter" data-level="4.2" data-path="good.html"><a href="good.html#consistent-use-of-indentation"><i class="fa fa-check"></i><b>4.2</b> Consistent use of indentation</a></li>
<li class="chapter" data-level="4.3" data-path="good.html"><a href="good.html#descriptive-use-of-variable-names"><i class="fa fa-check"></i><b>4.3</b> Descriptive use of variable names</a></li>
<li class="chapter" data-level="4.4" data-path="good.html"><a href="good.html#descriptive-and-informative-comments"><i class="fa fa-check"></i><b>4.4</b> Descriptive and informative comments</a></li>
<li class="chapter" data-level="4.5" data-path="good.html"><a href="good.html#a-clear-flow-and-structure"><i class="fa fa-check"></i><b>4.5</b> A clear flow and structure</a></li>
<li class="chapter" data-level="4.6" data-path="good.html"><a href="good.html#consistent-spacing"><i class="fa fa-check"></i><b>4.6</b> Consistent spacing</a></li>
<li class="chapter" data-level="4.7" data-path="good.html"><a href="good.html#if-required-the-use-of-functions-or-subroutines"><i class="fa fa-check"></i><b>4.7</b> If required, the use of functions or subroutines</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="code-structure.html"><a href="code-structure.html"><i class="fa fa-check"></i><b>5</b> Advanced: Optimising code structure</a></li>
<li class="chapter" data-level="6" data-path="testing.html"><a href="testing.html"><i class="fa fa-check"></i><b>6</b> Advanced: Testing code</a>
<ul>
<li class="chapter" data-level="6.1" data-path="testing.html"><a href="testing.html#in-script-testing"><i class="fa fa-check"></i><b>6.1</b> In-script testing</a></li>
<li class="chapter" data-level="6.2" data-path="testing.html"><a href="testing.html#formalised-testing"><i class="fa fa-check"></i><b>6.2</b> Formalised testing</a>
<ul>
<li class="chapter" data-level="6.2.1" data-path="testing.html"><a href="testing.html#software-testing"><i class="fa fa-check"></i><b>6.2.1</b> Software testing</a></li>
<li class="chapter" data-level="6.2.2" data-path="testing.html"><a href="testing.html#unit-testing"><i class="fa fa-check"></i><b>6.2.2</b> Unit testing</a></li>
<li class="chapter" data-level="6.2.3" data-path="testing.html"><a href="testing.html#testthat"><i class="fa fa-check"></i><b>6.2.3</b> testthat</a></li>
<li class="chapter" data-level="6.2.4" data-path="testing.html"><a href="testing.html#pytest"><i class="fa fa-check"></i><b>6.2.4</b> pytest</a></li>
<li class="chapter" data-level="6.2.5" data-path="testing.html"><a href="testing.html#testing-shiny-apps"><i class="fa fa-check"></i><b>6.2.5</b> Testing Shiny apps</a></li>
<li class="chapter" data-level="6.2.6" data-path="testing.html"><a href="testing.html#test-driven-development"><i class="fa fa-check"></i><b>6.2.6</b> Test driven development</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="7" data-path="VC.html"><a href="VC.html"><i class="fa fa-check"></i><b>7</b> Advanced: Version control</a></li>
<li class="chapter" data-level="8" data-path="documentation.html"><a href="documentation.html"><i class="fa fa-check"></i><b>8</b> Advanced: Documentation</a>
<ul>
<li class="chapter" data-level="8.1" data-path="documentation.html"><a href="documentation.html#comments"><i class="fa fa-check"></i><b>8.1</b> Comments</a></li>
<li class="chapter" data-level="8.2" data-path="documentation.html"><a href="documentation.html#rmarkdown-file"><i class="fa fa-check"></i><b>8.2</b> Rmarkdown file</a></li>
<li class="chapter" data-level="8.3" data-path="documentation.html"><a href="documentation.html#packaging-your-analysis"><i class="fa fa-check"></i><b>8.3</b> Packaging your analysis</a></li>
<li class="chapter" data-level="8.4" data-path="documentation.html"><a href="documentation.html#a-word-on-package-version-and-dependency"><i class="fa fa-check"></i><b>8.4</b> A word on package version and dependency</a></li>
</ul></li>
<li class="chapter" data-level="9" data-path="links.html"><a href="links.html"><i class="fa fa-check"></i><b>9</b> Links</a>
<ul>
<li class="chapter" data-level="9.1" data-path="links.html"><a href="links.html#internal-dfe-and-other-government-department-resources"><i class="fa fa-check"></i><b>9.1</b> Internal DfE and Other Government Department resources</a></li>
<li class="chapter" data-level="9.2" data-path="links.html"><a href="links.html#testing-1"><i class="fa fa-check"></i><b>9.2</b> Testing</a></li>
<li class="chapter" data-level="9.3" data-path="links.html"><a href="links.html#style-guides"><i class="fa fa-check"></i><b>9.3</b> Style Guides</a></li>
<li class="chapter" data-level="9.4" data-path="links.html"><a href="links.html#r"><i class="fa fa-check"></i><b>9.4</b> R</a></li>
</ul></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">DfE Good Code Practice</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<link href="style.css" rel="stylesheet">
<div class="hero-image-container"> 
  <img class= "hero-image" src="pictures/hero_img.png">
</div>
<div id="testing" class="section level1" number="6">
<h1><span class="header-section-number">Chapter 6</span> Advanced: Testing code</h1>
<p>From a coding point of view, testing covers the requirements spelled out in the <strong>Verification</strong> pillar of the QA framework. Note that testing does not overlap with the <strong>Validation</strong> QA pillar: it is concerned with code running properly rather than with the adequacy of analytical assumptions. Testing is a vast topic and as such this guide will cover console tests and in-script testing in brief and focus on formalised testing procedures, such as unit testing. These test the different components of “units” of code using tools such as testthat in R or Pytest in Python.</p>
<div class="infoboxred exclamation">
<p>Testing code within the console is not recommended as it leaves no trace or records of what has been checked.</p>
</div>
<div id="in-script-testing" class="section level2" number="6.1">
<h2><span class="header-section-number">6.1</span> In-script testing</h2>
<p>In-script testing is sufficient to facilitate QA in most cases, although tests should always be accompanied by brief comments signalling their presence and indicating what they are evaluating and what the expected output should be. For a quality assurer, running these tests ensures that the entire analytical workflow is reproducible. In R there are many ways to perform in-script checks, from <code>print()</code> statements, to <code>base</code> functions <code>stop()</code> and <code>stopfinot()</code>, to functions from dedicated packages such as <code>assertthat</code> or <code>testit</code>. Examples are shown below.</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r badCode"><code class="sourceCode r"><span id="cb9-1"><a href="testing.html#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co"># This code snippet creates a function that</span></span>
<span id="cb9-2"><a href="testing.html#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="co"># returns the maximum value of a vector</span></span>
<span id="cb9-3"><a href="testing.html#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="co"># of numbers. The function contains </span></span>
<span id="cb9-4"><a href="testing.html#cb9-4" aria-hidden="true" tabindex="-1"></a><span class="co"># an in-script test checking that</span></span>
<span id="cb9-5"><a href="testing.html#cb9-5" aria-hidden="true" tabindex="-1"></a><span class="co"># its input is numerical. If the condition</span></span>
<span id="cb9-6"><a href="testing.html#cb9-6" aria-hidden="true" tabindex="-1"></a><span class="co"># is not met, execution is halted</span></span>
<span id="cb9-7"><a href="testing.html#cb9-7" aria-hidden="true" tabindex="-1"></a>get_max <span class="ot">&lt;-</span> <span class="cf">function</span>(x) {</span>
<span id="cb9-8"><a href="testing.html#cb9-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stopifnot</span>(<span class="fu">is.numeric</span>(x))</span>
<span id="cb9-9"><a href="testing.html#cb9-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">max</span>(x)</span>
<span id="cb9-10"><a href="testing.html#cb9-10" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb9-11"><a href="testing.html#cb9-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-12"><a href="testing.html#cb9-12" aria-hidden="true" tabindex="-1"></a><span class="fu">get_max</span>(<span class="fu">c</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>))</span>
<span id="cb9-13"><a href="testing.html#cb9-13" aria-hidden="true" tabindex="-1"></a><span class="co"># returns 10</span></span>
<span id="cb9-14"><a href="testing.html#cb9-14" aria-hidden="true" tabindex="-1"></a><span class="fu">get_max</span>(<span class="fu">c</span>(<span class="st">&quot;a&quot;</span>, <span class="st">&quot;b&quot;</span>, <span class="st">&quot;c&quot;</span>))</span>
<span id="cb9-15"><a href="testing.html#cb9-15" aria-hidden="true" tabindex="-1"></a><span class="co"># returns error message</span></span>
<span id="cb9-16"><a href="testing.html#cb9-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Error in get_max(c(&quot;a&quot;, &quot;b&quot;, &quot;c&quot;)) : is.numeric(x) is not TRUE</span></span></code></pre></div>
<p>In Python similar approaches can be used. There is also a <a href="https://www.w3schools.com/python/ref_func_print.asp">print function</a> and exceptions provide a way of returning an error if a specified condition is met, much like the functionality offered by R’s <code>stop()</code> and <code>stopifnot()</code> functions. There is information about how to raise exceptions <a href="https://www.w3schools.com/python/gloss_python_raise.asp">here</a> or you can find more technical, detailed information about the different types of exceptions <a href="https://docs.python.org/3/library/exceptions.html">here</a>.</p>
</div>
<div id="formalised-testing" class="section level2" number="6.2">
<h2><span class="header-section-number">6.2</span> Formalised testing</h2>
<p>Beyond in-script tests, an analyst may decide to take a more formal approach to testing if the project warrants it. Software development has dedicated testing professionals (called “testers”) and there is plenty of literature about software testing on the internet. Much of this is transferable to code based analysis, but not all of it. There are times when it makes sense to make a distinction between a piece of analysis (which is generally operated by a technical specialist) and an IT product (e.g. a website, which is used by a broader user base). Shiny apps sit somewhere between analysis and an IT product therefore these are covered separately later on.</p>
<div class="infoboxyellow question">
<p>The following types of software testing are commonly used:</p>
<ul>
<li>Unit testing - tests the different components or “units” of code using tools such as <code>testthat</code> in R.</li>
<li>Integration testing - tests the correct flow of data through the components.</li>
<li>System testing - tests the overall outputs make sense.</li>
<li>Acceptance testing - tests whether or not the work meets its objectives.</li>
</ul>
</div>
<div id="software-testing" class="section level3" number="6.2.1">
<h3><span class="header-section-number">6.2.1</span> Software testing</h3>
<p>Before we focus on unit testing, it is important to note that the other testing aspects cover testing of wider areas of a software project than just the code, and other parts of the DfE QA framework cover how to handle these:</p>
<ul>
<li>Integration testing tests correct data flow, transformations and interactions between different parts of the analysis.</li>
<li>System testing relates to verification tests on the overall outputs.</li>
<li>Acceptance testing relates to the validation pillar of the QA framework.</li>
</ul>
<p>Software testing can make a distinction between functional and non-functional testing too. In the context of analysis, a functional test would be one which tests the analysis produces what its intended to whereas a non-functional test would cover things such as its run-time and interface (i.e. things which affect the experience of using it, but not the numbers that come out).</p>
<p>For more information, see <a href="https://www.guru99.com/levels-of-testing.html">here</a> or explore further with help from a search engine.</p>
</div>
<div id="unit-testing" class="section level3" number="6.2.2">
<h3><span class="header-section-number">6.2.2</span> Unit testing</h3>
<p>Unit testing seeks to test every distinct code component to enable isolation of specific areas that may be introducing errors. For code made up of functions, it is sometimes easier to think of this as testing each specific function.</p>
<p>One of the key principles of unit testing is that each unit (or function) should be tested independently of all the others and without dependency on any data sources that may change. The objective is to isolate the cause of any errors which means that unit tests should not rely on output from previous functions or rely on data from a live source (e.g SQL) as in both these instances it would not be possible to identify if the function being tested caused the error.</p>
<p>To write a good set of unit tests, think about the different types of input (e.g. positive values, zero values) the function may receive, define some fixed inputs to cover these and then write tests to ensure the different cases are handled correctly.</p>
<p>To implement unit tests, it is generally easiest to use a unit testing framework. These generally allow tests to be written in separate files and then all tests run at once, returning success/failure feedback.</p>
<ul>
<li>The <code>testthat</code> package is a popular tool to write and run tests in R (more details <a href="https://github.com/r-lib/testthat">here</a>)</li>
<li>The <code>pytest</code> framework offers a similar resource for Python (more details <a href="https://docs.pytest.org/en/latest/">here</a>)</li>
</ul>
</div>
<div id="testthat" class="section level3" number="6.2.3">
<h3><span class="header-section-number">6.2.3</span> testthat</h3>
<p>The <code>testthat</code> package, maintained by the RStudio team, is commonly used for unit testing in R. Although most of its documentation and features focus on testing in the context of package writing, <code>testthat</code> can also be used with regular R projects. There’s a brief overview of unit testing below, but for a more detailed introduction see <a href="https://katherinemwood.github.io/post/testthat/">here</a> or <a href="https://www.r-bloggers.com/automated-testing-with-testthat-in-practice/">here</a> for a more in-depth overview of automated testing, including test driven development.</p>
<p>In <code>testthat</code>, tests are called <strong>expectations</strong>. These spell out the expected behaviour of the function or unit of code. <code>testthat</code> provides many functions to define expectations - see details <a href="http://r-pkgs.had.co.nz/tests.html">here</a>. Expectations falling within a same testing context are stored in a same file and all testing files are saved within a dedicated testing directory. Below is an example of testing a simple function.</p>
<p>Firstly we need to have a defined function to test:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb10-1"><a href="testing.html#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a simple function to demonstrate testing approach</span></span>
<span id="cb10-2"><a href="testing.html#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tibble)</span>
<span id="cb10-3"><a href="testing.html#cb10-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-4"><a href="testing.html#cb10-4" aria-hidden="true" tabindex="-1"></a><span class="co"># create a data frame of random numbers</span></span>
<span id="cb10-5"><a href="testing.html#cb10-5" aria-hidden="true" tabindex="-1"></a>create_random_numbers_dataframe <span class="ot">&lt;-</span> <span class="cf">function</span>(n){</span>
<span id="cb10-6"><a href="testing.html#cb10-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tibble</span>(<span class="at">some_numbers =</span> <span class="fu">runif</span>(n))</span>
<span id="cb10-7"><a href="testing.html#cb10-7" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>Then we can define some tests for it:</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb11-1"><a href="testing.html#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co"># This file is stored in a directory called &quot;testing_directory&quot; </span></span>
<span id="cb11-2"><a href="testing.html#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Need the testthat package</span></span>
<span id="cb11-3"><a href="testing.html#cb11-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(testthat)</span>
<span id="cb11-4"><a href="testing.html#cb11-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-5"><a href="testing.html#cb11-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Need to source our function</span></span>
<span id="cb11-6"><a href="testing.html#cb11-6" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="st">&quot;file_where_function_saved.R&quot;</span>)</span>
<span id="cb11-7"><a href="testing.html#cb11-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-8"><a href="testing.html#cb11-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Need to run our function to be able to test its impact</span></span>
<span id="cb11-9"><a href="testing.html#cb11-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Could also do this within tests if we wanted to test different cases</span></span>
<span id="cb11-10"><a href="testing.html#cb11-10" aria-hidden="true" tabindex="-1"></a>mydata <span class="ot">&lt;-</span> <span class="fu">create_random_numbers_dataframe</span>(<span class="dv">100</span>)</span>
<span id="cb11-11"><a href="testing.html#cb11-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-12"><a href="testing.html#cb11-12" aria-hidden="true" tabindex="-1"></a><span class="co"># The first test checks that the data set</span></span>
<span id="cb11-13"><a href="testing.html#cb11-13" aria-hidden="true" tabindex="-1"></a><span class="co"># &quot;mydata&quot; has a a single column and 100 rows</span></span>
<span id="cb11-14"><a href="testing.html#cb11-14" aria-hidden="true" tabindex="-1"></a><span class="fu">test_that</span>(<span class="st">&#39;data dimensions correct&#39;</span>, {</span>
<span id="cb11-15"><a href="testing.html#cb11-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expect_equal</span>(<span class="fu">ncol</span>(mydata), <span class="dv">1</span>)</span>
<span id="cb11-16"><a href="testing.html#cb11-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expect_equal</span>(<span class="fu">nrow</span>(mydata), <span class="dv">100</span>)</span>
<span id="cb11-17"><a href="testing.html#cb11-17" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb11-18"><a href="testing.html#cb11-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-19"><a href="testing.html#cb11-19" aria-hidden="true" tabindex="-1"></a><span class="co"># The second test checks that the maximum value</span></span>
<span id="cb11-20"><a href="testing.html#cb11-20" aria-hidden="true" tabindex="-1"></a><span class="co"># of the variable &quot;some_numbers&quot; does not exceed 1</span></span>
<span id="cb11-21"><a href="testing.html#cb11-21" aria-hidden="true" tabindex="-1"></a><span class="fu">test_that</span>(<span class="st">&#39;no value greater than 1&#39;</span>, {</span>
<span id="cb11-22"><a href="testing.html#cb11-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expect_lte</span>(<span class="fu">max</span>(mydata<span class="sc">$</span>some_numbers), <span class="dv">1</span>)</span>
<span id="cb11-23"><a href="testing.html#cb11-23" aria-hidden="true" tabindex="-1"></a>})</span></code></pre></div>
<p>Expectations are tested using the <code>test_dir()</code> function, which takes the path to the testing directory as an argument:</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r badCode"><code class="sourceCode r"><span id="cb12-1"><a href="testing.html#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co"># test expectations and examine outputs</span></span>
<span id="cb12-2"><a href="testing.html#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="co"># In this case, all tests are OK</span></span>
<span id="cb12-3"><a href="testing.html#cb12-3" aria-hidden="true" tabindex="-1"></a><span class="fu">test_dir</span>(<span class="st">&quot;testing_directory&quot;</span>)</span></code></pre></div>
<p><code>test_dir()</code> provides detailed outputs, including a time line of success/failure and any warnings that may have occurred.</p>
</div>
<div id="pytest" class="section level3" number="6.2.4">
<h3><span class="header-section-number">6.2.4</span> pytest</h3>
<p><code>pytest</code> provides similar functionality for Python as testthat does for R. When getting started with <code>pytest</code>, note that <code>pytest</code> implements a test discovery method to find relevant tests. Unless specified otherwise, test files are assumed to be in the current working directory or a sub-folder thereof. It is possible to setup <code>testpaths</code> to specify different file paths for test files if this better fits the project structure. Within these folders, pytest will discover tests in Python files named as <code>test_*.py</code> or <code>*_test.py</code>. The tests themselves then need to be functions named <code>test_*</code> to be detected as tests.</p>
<p>Whereas <code>testthat</code> has functions to define its expectations, <code>pytest</code> makes use of Pythons <code>assert</code> statement to specify the condition the test expects to be met.</p>
<p>Python IDEs can come with integration for <code>pytest</code>, making it possible to run tests at the click of the button. If you are using Spyder see <a href="https://www.spyder-ide.org/blog/introducing-unittest-plugin/">here</a> or PyCharm see <a href="https://www.jetbrains.com/help/pycharm/pytest.html">here</a>.</p>
</div>
<div id="testing-shiny-apps" class="section level3" number="6.2.5">
<h3><span class="header-section-number">6.2.5</span> Testing Shiny apps</h3>
<p>R Shiny apps include not only analysis, but also a user interface and server logic. This makes them closer to a software development project than the average piece of analytical work and additional functionality is available within R to support testing of Shiny apps. Useful demonstrations of some methods can be found <a href="https://shiny.rstudio.com/articles/testing-overview.html">here</a> and <a href="https://mastering-shiny.org/scaling-testing.html">here</a>.</p>
<p>Unit, integration and systems testing can all be automated with a little extra consideration given to the structure of your shiny code.</p>
<p>Pulling functions out of reactive objects allows unit testing to be implemented for those functions. Take the following simple reactive object that doubles the value of the input labelled <code>x</code>:</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb13-1"><a href="testing.html#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="fu">reactive</span>({</span>
<span id="cb13-2"><a href="testing.html#cb13-2" aria-hidden="true" tabindex="-1"></a>  input<span class="sc">$</span>x <span class="sc">*</span> <span class="dv">2</span></span>
<span id="cb13-3"><a href="testing.html#cb13-3" aria-hidden="true" tabindex="-1"></a>})</span></code></pre></div>
<p>The function can be pulled out of the reactive environment.</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb14-1"><a href="testing.html#cb14-1" aria-hidden="true" tabindex="-1"></a>doubler <span class="ot">&lt;-</span> <span class="cf">function</span>(x) x <span class="sc">*</span> <span class="dv">2</span></span></code></pre></div>
<p>This function can be tested in the usual way. The reactive object in the server code is then just a call to the function.</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb15-1"><a href="testing.html#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="fu">reactive</span>({</span>
<span id="cb15-2"><a href="testing.html#cb15-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">doubler</span>(input<span class="sc">$</span>x)</span>
<span id="cb15-3"><a href="testing.html#cb15-3" aria-hidden="true" tabindex="-1"></a>})</span></code></pre></div>
<p>The structure of a shiny app used to make integration testing more difficult as the flow of data occurs only when the app is running. However, <code>shiny</code> version 1.5.0 includes a couple of functions that allow easy access to these environments for testing. The functions <code>testServer</code> and <code>testModule</code> allow manipulation and inspection of the server parameters (e.g <code>input</code>, <code>output</code> and <code>session</code>) as well as allowing objects created in the session to be inspected.</p>
<p>For example, let’s place an example function within some server code, where a number is supplied by the user (labelled <code>x</code>) and the doubled amount is output as text.</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb16-1"><a href="testing.html#cb16-1" aria-hidden="true" tabindex="-1"></a>server <span class="ot">&lt;-</span> <span class="cf">function</span>(input, output, session){</span>
<span id="cb16-2"><a href="testing.html#cb16-2" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb16-3"><a href="testing.html#cb16-3" aria-hidden="true" tabindex="-1"></a>  output<span class="sc">$</span>value <span class="ot">&lt;-</span> <span class="fu">renderText</span>({</span>
<span id="cb16-4"><a href="testing.html#cb16-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">paste</span>(<span class="st">&quot;Doubled:&quot;</span>, <span class="fu">doubler</span>(input<span class="sc">$</span>x))</span>
<span id="cb16-5"><a href="testing.html#cb16-5" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb16-6"><a href="testing.html#cb16-6" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb16-7"><a href="testing.html#cb16-7" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>The integration of the doubler function with the input and output can be tested by amending inputs and setting expectations as in the following example:</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb17-1"><a href="testing.html#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="fu">testServer</span>(</span>
<span id="cb17-2"><a href="testing.html#cb17-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">expr =</span> {</span>
<span id="cb17-3"><a href="testing.html#cb17-3" aria-hidden="true" tabindex="-1"></a>    session<span class="sc">$</span><span class="fu">setInputs</span>(<span class="at">x =</span> <span class="dv">2</span>) <span class="co"># set input$x to 2</span></span>
<span id="cb17-4"><a href="testing.html#cb17-4" aria-hidden="true" tabindex="-1"></a>    testthat<span class="sc">::</span><span class="fu">expect_equal</span>(output<span class="sc">$</span>value, <span class="st">&quot;Doubled: 4&quot;</span>)</span>
<span id="cb17-5"><a href="testing.html#cb17-5" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb17-6"><a href="testing.html#cb17-6" aria-hidden="true" tabindex="-1"></a>  )</span></code></pre></div>
<p>Checking the connections between the server and the user interface are implemented correctly can be automated using the <code>shinytest</code> package. This runs the app, records user interactions, and takes snapshots of the application state. In future runs, the saved user interactions are simulated and the resulting state compared to the appropriate snapshot.</p>
<p>Snapshot tests are recorded using <code>shinytest::recordTest(".")</code>. In the below image of the test recording app that is launched, the numeric input value has been changed, the output has updated and the application is saved in the resulting state. When the app is exited, using the <em>Save script and exit test recorder</em> button, a test will be generated and saved in the <code>tests/shinytest</code> subfolder. When the tests are run with <code>shinytest::testApp(".")</code>, the app will run invisibly, test scripts run, and snapshots compared. Further details can be found <a href="https://rstudio.github.io/shinytest/articles/shinytest.html">here</a>.</p>
<div class="figure">
<img src="screenshot.PNG" alt="" />
<p class="caption">Recording a test and snapshot using `shinytest::recordTest(“.”)</p>
</div>
<p>To create and test snapshots <code>shinytest</code> runs the app in a headless browser. To avoid proxy issues when running these tests, remove http proxy settings for the session using the following command.</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb18-1"><a href="testing.html#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="fu">Sys.unsetenv</span>(<span class="st">&quot;http_proxy&quot;</span>)</span></code></pre></div>
<p>It is important not to overlook usability testing (also known as UX testing or user experience testing) when creating an app. While this cannot be automated, there is immense value in watching a third party use an app. It does not matter how immaculate the code is if the end-user finds the app hard to use or difficult to parse. As such, usability testing should form part of any QA process involving shiny apps.</p>
</div>
<div id="test-driven-development" class="section level3" number="6.2.6">
<h3><span class="header-section-number">6.2.6</span> Test driven development</h3>
<p>“Test driven development” describes a way of working where tests are written prior to the code being written. Working out what working code encompasses before writing it allows immediate checking of whether new code works and avoids any retrofitting of tests to match achieved output. With a strong QA plan, this could also be implemented for analysis. As testing of each new bit of code happens immediately after creation it also reduces the risk of something faulty getting heavily baked in. As with testing, there are plenty of resources on the internet such as <a href="https://www.guru99.com/test-driven-development.html">this one</a>.</p>

</div>
</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="code-structure.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="VC.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": [["Good-Coding-Practice.pdf", "PDF"]],
"toc": {
"collapse": "section"
}
});
});
</script>

</body>

</html>
